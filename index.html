<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>
  <body>   
    <div>
        <label for="heapset">Set a heap (separating elements with commas)</label>
        <input id="heapset">
        <button id="drawheap">Draw a given heap</button>
        <button id="addOne">Add one</button>
        <button id="addAll">Add all</button>
    </div>
    <div>
        <label> Animation speed:
            <input id="speed" type="range" min="3" max="20" value="10">
        </label>
    </div>
    <canvas id="myCanvas" width="1280" height="720"></canvas>
    <script>
      window.requestAnimFrame = (function(callback) {
        return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
        function(callback) {
          window.setTimeout(callback, 1000 / 60);
        };
      })();
      function initBalls(str) {
        balls = [];

        for (var i = 0; i < str.length; i++){
            balls.push(new Ball(i*70 + 40, 50, 0, 0, blue, str[i]));
            
        }
        // G
        //balls.push(new Ball(173, 63, 0, 0, blue));
        
        return balls;
      }
      function Ball(x, y, vx, vy, color, number) {
        this.x = x;
        this.y = y;
        this.number = number;
        this.vx = vx;
        this.vy = vy;
        this.color = color;
        this.origX = x;
        this.origY = y;
        this.radius = radius;
      }
      
      function moveTo(ball){
           var dist = Math.sqrt(Math.pow(ball.x - xTo, 2) + Math.pow(ball.y - yTo, 2));
           if (dist < step){
               ball.x = xTo;
               ball.y = yTo;
               ball.origX = xTo;
               ball.origY = yTo;
               return true;
           }
           
           if (ball.x > xTo){
               ball.x = ball.x - ((ball.x - xTo) / (dist/step));
           }else{
               ball.x = ball.x + ((xTo - ball.x) / (dist/step));
           }
           if (ball.y > yTo){
               ball.y = ball.y - ((ball.y - yTo) / (dist/step));
           }else{
               ball.y = ball.y + ((yTo - ball.y) / (dist/step));
           }
           return false;
      }
      
      function swapTo(ballA, ballB){
           var dist = Math.sqrt(Math.pow(ballA.x - ballB.origX, 2) + Math.pow(ballA.y - ballB.origY, 2));
           if (dist < step){
               return true;
           }
           
           if (ballA.x > ballB.origX){
               ballA.x = ballA.x - ((ballA.x - ballB.origX) / (dist/step));
               ballB.x = ballB.x + ((ballA.origX - ballB.x) / (dist/step));
           }else{
               ballA.x = ballA.x + ((ballB.origX - ballA.x) / (dist/step));
               ballB.x = ballB.x - ((ballB.x - ballA.origX) / (dist/step));
           }
           if (ballA.y > ballB.origY){
               ballA.y = ballA.y - ((ballA.y -  ballB.origY) / (dist/step));
               ballB.y = ballB.y - ((ballB.y -  ballA.origY) / (dist/step));
           }else{
               ballA.y = ballA.y + (( ballB.origY - ballA.y) / (dist/step));
               ballB.y = ballB.y - ((ballB.y -  ballA.origY) / (dist/step));
           }
           return false;
      
      }
      
      function swap(x, y){
          var local = new Ball(heap[y].origX, heap[y].origY, 0, 0, heap[x].color, heap[x].number);
          heap[x] = new Ball(heap[x].origX, heap[x].origY, 0, 0, heap[y].color, heap[y].number);
          heap[y] = local;
      }
      
      function siftUp(){
          if (heap[positinOfSwapping].number < heap[parseInt((positinOfSwapping-1)/2)].number){
              return true;
          }else return false;
      }
      
      
      function drawLines(i){
          var context = canvas.getContext('2d');
          context.beginPath();
          context.moveTo(heap[i].origX, heap[i].origY);
          if ((2*i + 2) < heap.length){
            context.lineTo(heap[2*i + 1].origX, heap[2*i + 1].origY);
            context.stroke();
            drawLines(2*i + 1);
            context.moveTo(heap[i].origX, heap[i].origY);
            context.lineTo(heap[2*i + 2].origX, heap[2*i + 2].origY);            
            context.stroke();
            drawLines(2*i+2);
          } else if ((2*i + 1) < heap.length){
            context.lineTo(heap[2*i + 1].origX, heap[2*i + 1].origY);
            context.stroke();
            drawLines(2*i + 1);   
          } else{
             return;
          }
          
          return;
      }
      
      function drawCircrles(allBalls){
        var context = canvas.getContext('2d');
        for(var n = 0; n < allBalls.length; n++) {
          var ball = allBalls[n];
          context.beginPath();
          context.arc(ball.x, ball.y, ball.radius, 0, 2 * Math.PI, false);
          context.fillStyle = ball.color;
          context.fill();
        }
        for(var n = 0; n < allBalls.length; n++) {
          var ball = allBalls[n];
          context.beginPath();
          context.fillStyle = "#000";
          context.font = 'bold 15px sans-serif';
          context.fillText(ball.number, ball.x-5, ball.y+5);
          context.fill();
        }  
          
      }
      
      function animate() {
        var context = canvas.getContext('2d');
        step = document.getElementById("speed").value;
        // update
        var date = new Date();
        var time = date.getTime();
        //var timeDiff = time - lastTime;
        //updateBalls(canvas, balls, timeDiff, mousePos);
        lastTime = time;

        // clear
        context.clearRect(0, 0, canvas.width, canvas.height);
        /*if (heap.length > 3){
            isMoving = true;
            isSwapping = true;
            ballA =heap[0];
            ballB = heap[3];
            ballA.color = yellow;
            ballB.color = yellow; 
        }*/
        
        if (isMoving){
           if (isSwapping){
               if (siftUp()){
                    ballA = (heap[positinOfSwapping]);
                    ballB = heap[parseInt((positinOfSwapping-1)/2)];
                    if (swapTo(ballA, ballB)){
                       ballA.color = blue;
                       ballB.color = blue; 
                       swap(positinOfSwapping, parseInt((positinOfSwapping-1)/2));
                       positinOfSwapping = parseInt((positinOfSwapping-1)/2);
                       //heap.pop();
                    }
               }else{
                   isSwapping = false; 
                   if (addingToHeap.length > 0){
                       addNext();
                   }else isMoving = false;
               }
           }else if (moveTo(ballTo)){
                   var local = balls[balls.length - 1];
                   heap.push(new Ball(local.x, local.y, 0, 0, blue, local.number));
                   balls.pop();
                   isSwapping = true;
                   positinOfSwapping = heap.length - 1;
           }
        }
        // render
        var allBalls = balls.concat(heap);
        if (heap.length > 0) drawLines(0);
        drawCircrles(allBalls);
        

        // request new frame
        requestAnimFrame(function() {
          animate();
        });
      }
      
      function Coord(x,y){
          this.x = x;
          this.y = y;
      }
      
      function getNextPosition(){
          var n = Math.round(Math.log(position)/Math.log(2) - 0.5);
          console.log(position);
          console.log(n);
          var k = position - Math.pow(2,n);
          console.log(k);
          position++;
          return (new Coord( canvas.width/(Math.pow(2,n)+1)*(k+1), (canvas.height - 2*radius + 20)/(Math.round(Math.log(heap.length + balls.length)/Math.log(2)) + 1)*(n+1) + 10));
      }
      
      function addNext(){
          var coord = getNextPosition();
          xTo = coord.x;
          yTo = coord.y;
          ballTo = addingToHeap.pop();
          ballTo.color = red;
      }
      
      
        var canvas = document.getElementById('myCanvas');
        var date = new Date();
        var time = date.getTime();
        var heap = [];
        var addingToHeap = [];
        var balls = [];
        var isMoving = false;
        var isSwapping = false;
        var step = 10;
        var xTo, yTo, ballTo, ballA, ballB;
        var toHeap = false;
        var radius = 30;
        var position;
        var positinOfSwapping;
        var blue = '#3A5BCD';
        var red = '#EF2B36';
        var yellow = '#FFC636';
        var green = '#02A817';
        animate();
        
        
        
        
        document.getElementById("drawheap").addEventListener("click", function () {
            if (!isMoving){
                position = 1;
                var str = document.getElementById("heapset").value.split(",");
                for (var i = 0; i < str.length; ++i){
                    str[i] = parseInt(str[i]);
                }
                balls = [];
                heap = [];
                balls = initBalls(str);
                canvas.width = balls.length*(2*radius + 10) + 100;
                canvas.height = (Math.round(Math.log(balls.length)/Math.log(2) + 0.5) + 1) * (3*radius + 10);
                //
            }
        });
        
        document.getElementById("addOne").addEventListener("click", function () {
            if (!isMoving && balls.length > 0){          
                isMoving = true;
                addingToHeap.push(balls[balls.length - 1]);
                addNext();
                //console.log(balls);
                //console.log(heap);
                //animate(canvas, balls, time, heap);
            }
        });
        document.getElementById("addAll").addEventListener("click", function () {
            if (!isMoving && balls.length > 0){          
                isMoving = true;
                addingToHeap = addingToHeap.concat(balls);
                addNext();
                //console.log(ballTo);
                console.log(balls);
                console.log(heap);
                //animate(canvas, balls, time, heap);
            }
        });
    </script>
  </body>
</html>
      
